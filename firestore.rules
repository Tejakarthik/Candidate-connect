rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Default deny all access
    match /{document=**} {
      allow read, write: if false;
    }

    // USERS collection
    // Anyone can create their own user document upon registration.
    // Any authenticated user can read user profiles (for mentions, etc.).
    // A user can only update their own profile.
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create, update: if request.auth.uid == userId;
    }
    
    // CANDIDATES collection
    match /candidates/{candidateId} {
      // Any authenticated user can create a new candidate or read the list of candidates.
      allow create, read: if request.auth != null;

      // The user who created the candidate can update it (e.g., assign more users) or delete it.
      // Note: This is more restrictive than before, where any assigned user could update.
      allow update, delete: if request.auth.uid == resource.data.createdBy;

      // Sub-collections (notes, history)
      // These have their own, more restrictive rules to protect sensitive data.
      
      // NOTES sub-collection
      match /notes/{noteId} {
        allow read, create: if hasCandidateAccess();
        // Allow update/delete only if the user is the author of the note.
        allow update, delete: if hasCandidateAccess() && request.auth.uid == resource.data.authorId;
      }
      
      // HISTORY sub-collection (Audit Trail)
      match /history/{historyId} {
        // Allow read for anyone with access to the candidate.
        allow read: if hasCandidateAccess();
        // Allow create for anyone with access to the candidate.
        allow create: if hasCandidateAccess();
        // Explicitly deny updates or deletes to make the audit trail immutable.
        allow update, delete: if false;
      }
    }
    
    // NOTIFICATIONS sub-collection (nested under users)
    match /users/{userId}/notifications/{notificationId} {
      // A user can read, update, or delete their own notifications.
      allow read, update, delete: if request.auth.uid == userId;
      // Any authenticated user can create a notification (e.g., for a mention).
      allow create: if request.auth != null;
    }
  }
} 